<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>

    <link rel="stylesheet" href="/assets/css/core/fonts.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    ::-webkit-scrollbar {
      width: 5px;
      height: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #0f0f0f;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #f75454;
      border-radius: 10px;
      transition: all 0.5s ease-in-out;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff2e2e;
    }

    body {
      font-family: 'montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0B0B0B;
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #1a1a1a;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      overflow: hidden;
      border: 1px solid #333;
    }

    header {
      background: linear-gradient(137deg, rgba(36, 36, 36, 1) 0%, rgba(14, 14, 14, 1) 26%, rgba(14, 14, 14, 1) 100%);
      color: white;
      padding: 30px;
      text-align: center;
      border-bottom: 2px solid #ff2525;
    }

    header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #ff2525, #ff7272);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: #999;
      font-size: 0.95em;
    }

    .tabs {
      display: flex;
      background: #0f0f0f;
      border-bottom: 2px solid #333;
    }

    .tab-button {
      flex: 1;
      padding: 15px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #888;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      background: #1a1a1a;
      color: #ccc;
    }

    .tab-button.active {
      color: #ff2525;
      border-bottom-color: #ff2525;
    }

    .content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 0;
      min-height: 600px;
    }

    .sidebar {
      background: #0f0f0f;
      border-right: 2px solid #333;
      padding: 20px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .sidebar h2 {
      color: #ff2525;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .main-section {
      padding: 30px;
      overflow-y: auto;
      max-height: 70vh;
      background: #151515;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }

    label {
      font-weight: 600;
      color: #ccc;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="password"],
    select,
    textarea {
      padding: 10px;
      border: 2px solid #333;
      border-radius: 5px;
      font-family: inherit;
      font-size: 1em;
      background: #222;
      color: #e0e0e0;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #ff2525;
      box-shadow: 0 0 8px rgba(255, 37, 37, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(90deg, #ff2525 0%, #ff6b6b 100%);
      color: white;
      width: 100%;
      margin-bottom: 10px;
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, #ff1a1a 0%, #ff5555 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 37, 37, 0.3);
    }

    .btn-danger {
      background: #c0392b;
      color: white;
      width: 100%;
    }

    .btn-danger:hover {
      background: #a93226;
      box-shadow: 0 5px 15px rgba(192, 57, 43, 0.3);
    }

    .btn-add {
      background: linear-gradient(90deg, #ff2525 0%, #ff6b6b 100%);
      color: white;
      width: 100%;
      margin-top: 10px;
    }

    .btn-add:hover {
      background: linear-gradient(90deg, #ff1a1a 0%, #ff5555 100%);
      transform: translateY(-2px);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background: #222;
      border: 2px solid #333;
      border-radius: 5px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .list-item:hover {
      border-color: #ff2525;
      background: #2a2a2a;
      transform: translateX(5px);
    }

    .list-item.active {
      border-color: #ff2525;
      background: #ff2525;
      color: white;
    }

    .list-item h4 {
      margin-bottom: 5px;
      font-size: 0.95em;
      color: #fff;
    }

    .list-item p {
      font-size: 0.85em;
      opacity: 0.8;
      margin: 2px 0;
      color: #aaa;
    }

    .list-item.active p {
      opacity: 0.95;
      color: #ffe0e0;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .message.error {
      background: rgba(255, 37, 37, 0.2);
      color: #ff5555;
      border: 1px solid rgba(255, 37, 37, 0.3);
    }

    .no-selection {
      color: #666;
      text-align: center;
      padding: 40px 20px;
      font-style: italic;
    }

    .section-title {
      color: #ff2525;
      font-size: 1.1em;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 2px solid #ff2525;
      padding-bottom: 8px;
    }

    .dropdown-item {
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item-num {
      font-size: 0.85em;
      color: #ff2525;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .dropdown-fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dropdown-fields input,
    .dropdown-fields textarea {
      font-size: 0.9em;
      padding: 8px;
    }

    .btn-remove {
      background: #c0392b;
      color: white;
      font-size: 0.85em;
      padding: 6px 12px;
      width: 100%;
      margin-top: 8px;
    }

    .btn-remove:hover {
      background: #a93226;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 0;
      min-height: 600px;
    }

    small {
      color: #888;
    }
  </style>
  </style>
</head>
<body>

  <nav>
    <div id="navbar"></div>
    <script src="/assets/js/components/navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/navbar.css">
  </nav>
  <mobilenav>
    <div id="mobilenavbar"></div>
    <script src="/assets/js/components/mobile-navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/mobile-navbar.css">
  </mobilenav>



<div class="container">
  <header>
    <h1>‚öôÔ∏è Admin Panel</h1>
    <p>Manage carousel cards and users</p>
  </header>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('carousel')">üìä Carousel</button>
    <button class="tab-button" onclick="switchTab('users')">üë• Users</button>
  </div>

  <!-- CAROUSEL TAB -->
  <div id="carousel" class="tab-content active">
    <!-- SIDEBAR: Card List -->
    <div class="sidebar">
      <h2>Cards</h2>
      <div id="cards-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewCard()" style="margin-top: 15px;">+ New Card</button>
      <button class="btn-primary" onclick="loadCards()" style="margin-top: 10px;">üîÑ Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit Card -->
    <div class="main-section">
      <div id="carousel-message" class="message"></div>

      <div id="no-card-selection" class="no-selection">
        Select a card to edit or create a new one
      </div>

      <div id="edit-card-form" style="display: none;">
        <div class="form-group">
          <label for="card-date">Date *</label>
          <input type="date" id="card-date">
        </div>

        <div class="form-group">
          <label for="card-title">Card Title *</label>
          <input type="text" id="card-title" placeholder="e.g., 2026 Week 4">
        </div>

        <div class="form-group">
          <label for="card-subtitle">Subtitle</label>
          <input type="text" id="card-subtitle" placeholder="e.g., Champions League">
        </div>

        <div class="form-group">
          <label for="card-description">Short Description</label>
          <textarea id="card-description" placeholder="Brief description..."></textarea>
        </div>

        <div class="section-title">Matches / Predictions</div>
        <div id="dropdowns-container"></div>
        <button class="btn-add" onclick="addDropdownSection()">+ Add Match / Prediction</button>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <button class="btn-primary" onclick="saveCard()">üíæ Save Card</button>
        <button class="btn-danger" onclick="deleteCard()">üóëÔ∏è Delete Card</button>
      </div>
    </div>
  </div>

  <!-- USERS TAB -->
  <div id="users" class="tab-content">
    <!-- SIDEBAR: User List -->
    <div class="sidebar">
      <h2>Users</h2>
      <div id="users-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewUser()" style="margin-top: 15px;">+ New User</button>
      <button class="btn-primary" onclick="loadUsers()" style="margin-top: 10px;">üîÑ Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit User -->
    <div class="main-section">
      <div id="users-message" class="message"></div>

      <div id="no-user-selection" class="no-selection">
        Select a user to edit or create a new one
      </div>

      <div id="edit-user-form" style="display: none;">
        <div class="form-group">
          <label for="user-name">Name *</label>
          <input type="text" id="user-name" placeholder="Full name">
        </div>

        <div class="form-group">
          <label for="user-email">Email *</label>
          <input type="email" id="user-email" placeholder="email@example.com">
        </div>

        <div class="form-group">
          <label for="user-password">Password *</label>
          <input type="password" id="user-password" placeholder="Password (leave empty to keep current)">
          <small style="color: #666;">Leave empty to keep the current password when editing</small>
        </div>

        <div class="form-group">
          <label for="user-role">Role *</label>
          <select id="user-role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="user-uid">User UID (Read-only)</label>
          <input type="text" id="user-uid" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="form-group">
          <label for="user-created">Created At (Read-only)</label>
          <input type="text" id="user-created" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <button class="btn-primary" onclick="saveUser()">üíæ Save User</button>
        <button class="btn-danger" onclick="deleteUser()">üóëÔ∏è Delete User</button>
      </div>
    </div>
  </div>
</div>

<script>
let editingCardId = null;
let editingUserId = null;

// ========== AUTHENTICATION CHECK ==========
async function checkAdminAuth() {
  try {
    const response = await fetch('/api/session');
    const result = await response.json();

    if (!result.loggedIn || !result.user) {
      // Not logged in - redirect to login
      window.location.href = '/login/';
      return false;
    }

    // Check if user has admin role
    if (result.user.role !== 'admin') {
      // Not an admin - show error and redirect
      alert('‚õî Access denied. Admin access required.');
      window.location.href = '/';
      return false;
    }

    // User is admin, show admin panel
    console.log('‚úÖ Logged in as admin:', result.user.name);
    loadCompetitions(); // Load competitions dropdown
    loadCards(); // Auto-load carousel on page load
    return true;
  } catch (err) {
    console.error('Auth check error:', err);
    window.location.href = '/login/';
    return false;
  }
}

// Run auth check on page load
document.addEventListener('DOMContentLoaded', checkAdminAuth);

// ========== COMPETITIONS MANAGEMENT ==========
async function loadCompetitions() {
  try {
    const response = await fetch('/api/competitions');
    const result = await response.json();

    if (!result.success) return;

    const select = document.getElementById('card-competition');
    select.innerHTML = '<option value="">-- Select Competition --</option>';

    result.data.forEach(comp => {
      const option = document.createElement('option');
      option.value = comp.id;
      option.textContent = comp.name;
      if (comp.icon) option.dataset.icon = comp.icon;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

function showCompetitionIcon() {
  const select = document.getElementById('card-competition');
  const selectedOption = select.options[select.selectedIndex];
  const icon = selectedOption.dataset.icon;
  const preview = document.getElementById('competition-icon-preview');
  const img = document.getElementById('competition-icon-img');

  if (icon) {
    // Check if it's a URL or a filename
    const iconPath = icon.startsWith('http') ? icon : `/assets/images/league-icons/${icon}`;
    img.src = iconPath;
    img.onerror = () => {
      img.src = '/assets/images/league-icons/default.png';
    };
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

async function addNewCompetition() {
  const name = document.getElementById('card-new-competition').value.trim();
  const icon = document.getElementById('card-new-competition-icon').value.trim();
  
  if (!name) {
    showMessage('carousel-message', 'Competition name is required', 'error');
    return;
  }

  try {
    const response = await fetch('/api/competitions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, icon: icon || null })
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    document.getElementById('card-new-competition').value = '';
    document.getElementById('card-new-competition-icon').value = '';
    showMessage('carousel-message', '‚úì Competition added!', 'success');
    loadCompetitions();
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// ========== TAB SWITCHING ==========
function switchTab(tab) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

  // Show selected tab
  document.getElementById(tab).classList.add('active');
  event.target.classList.add('active');

  // Load data for the tab
  if (tab === 'carousel') {
    loadCards();
  } else if (tab === 'users') {
    loadUsers();
  }
}

// ========== CAROUSEL FUNCTIONS ==========
async function loadCards() {
  try {
    const response = await fetch('/api/carousel/insights');
    
    if (response.status === 401) {
      showMessage('carousel-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Failed to load cards', 'error');
      return;
    }

    const cardsList = document.getElementById('cards-list');
    cardsList.innerHTML = '';

    if (result.data.length === 0) {
      cardsList.innerHTML = '<div style="color: #999; text-align: center;">No cards found</div>';
      return;
    }

    result.data.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.className = 'list-item';
      cardEl.onclick = () => selectCard(card);

      const dateStr = card.date ? new Date(card.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No date';

      cardEl.innerHTML = `
        <h4>${card.title}</h4>
        <p>${dateStr} ‚Ä¢ ID: ${card.id}</p>
        <p>${card.dropdowns?.length || 0} dropdowns</p>
      `;

      cardsList.appendChild(cardEl);
    });
  } catch (error) {
    console.error('Error loading cards:', error);
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

function selectCard(card) {
  editingCardId = card.id;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = card.date || new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = card.title || '';
  document.getElementById('card-subtitle').value = card.subtitle || '';
  document.getElementById('card-description').value = card.description || '';

  const dropdownsContainer = document.getElementById('dropdowns-container');
  dropdownsContainer.innerHTML = '';

  if (card.dropdowns && card.dropdowns.length > 0) {
    card.dropdowns.forEach((dropdown, idx) => {
      renderDropdownEditor(dropdown, idx);
    });
  }

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('carousel-message', `Editing: ${card.title}`, 'success');
}

function renderDropdownEditor(dropdown, index) {
  const container = document.getElementById('dropdowns-container');
  const dropdownEl = document.createElement('div');
  dropdownEl.className = 'dropdown-item';
  dropdownEl.dataset.dropdownIndex = index;

  dropdownEl.innerHTML = `
    <div class="dropdown-item-num">Match / Prediction ${index + 1}</div>
    <div class="dropdown-fields">
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin-bottom: 5px;">Match Details</label>
      <input type="text" class="dropdown-header" placeholder="Match (e.g., Over 2.5 Goals)" value="${dropdown.header || ''}">
      <input type="text" class="dropdown-subheader" placeholder="Teams (e.g., Arsenal vs Newcastle)" value="${dropdown.subheader || ''}">
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">Location</label>
      <input type="text" class="dropdown-location" placeholder="e.g., Emirates Stadium" value="${dropdown.location || ''}">
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">GMT Time (Kickoff)</label>
      <input type="time" class="dropdown-gmt-time" value="${dropdown.gmt_time || ''}">
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">Competition</label>
      <div style="display: flex; gap: 8px; align-items: flex-start;">
        <div style="flex: 1;">
          <select class="dropdown-competition" onchange="showDropdownCompetitionIcon(this)">
            <option value="">-- Select Competition --</option>
          </select>
          <div class="dropdown-competition-preview" style="margin-top: 8px; text-align: center; display: none;">
            <img class="dropdown-competition-icon" src="" alt="Competition Icon" style="max-height: 40px; border-radius: 5px;">
          </div>
        </div>
        <button class="btn-manage-comp" onclick="openCompetitionManager(event)" style="margin-top: 20px; padding: 8px 12px; background: #ff2525; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.85em;">‚öôÔ∏è Manage</button>
      </div>
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">Link</label>
      <input type="text" class="dropdown-link" placeholder="e.g., https://example.com/match" value="${dropdown.link || ''}">
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">Additional Info</label>
      <input type="text" class="dropdown-subheader2" placeholder="Secondary info (optional)" value="${dropdown.subheader2 || ''}">
      
      <label style="color: #ccc; font-weight: 600; font-size: 0.9em; margin: 10px 0 5px 0;">Analysis/Reasoning</label>
      <textarea class="dropdown-text" placeholder="Text/Reasoning...">${dropdown.text || ''}</textarea>
      
      <button class="btn-remove" onclick="removeDropdown(${index})">Remove Match / Prediction</button>
    </div>
  `;

  container.appendChild(dropdownEl);
  
  // Load competitions into this dropdown's select
  loadCompetitionsForDropdown(dropdownEl.querySelector('.dropdown-competition'), dropdown.competition_id);
}

async function loadCompetitionsForDropdown(selectElement, selectedId) {
  try {
    const response = await fetch('/api/competitions');
    const result = await response.json();

    if (!result.success) return;

    selectElement.innerHTML = '<option value="">-- Select Competition --</option>';

    result.data.forEach(comp => {
      const option = document.createElement('option');
      option.value = comp.id;
      option.textContent = comp.name;
      if (comp.icon) option.dataset.icon = comp.icon;
      if (comp.id == selectedId) option.selected = true;
      selectElement.appendChild(option);
    });
    
    // Show icon if already selected
    if (selectedId) {
      showDropdownCompetitionIcon(selectElement);
    }
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

function showDropdownCompetitionIcon(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const icon = selectedOption.dataset.icon;
  const preview = selectElement.closest('.dropdown-fields').querySelector('.dropdown-competition-preview');
  const img = preview.querySelector('.dropdown-competition-icon');

  if (icon) {
    const iconPath = icon.startsWith('http') ? icon : `/assets/images/league-icons/${icon}`;
    img.src = iconPath;
    img.onerror = () => {
      img.src = '/assets/images/league-icons/default.png';
    };
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

function openCompetitionManager(event) {
  event.preventDefault();
  const modal = document.createElement('div');
  modal.id = 'comp-manager-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;

  const dialog = document.createElement('div');
  dialog.style.cssText = `
    background: #0B0B0B;
    border: 2px solid #ff2525;
    border-radius: 10px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    color: #ccc;
  `;

  dialog.innerHTML = `
    <h2 style="color: #ff2525; margin-bottom: 20px;">Manage Competitions</h2>
    
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; font-size: 1em; margin-bottom: 10px;">Add New Competition</h3>
      <input type="text" id="new-comp-name" placeholder="Competition name" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 5px;">
      <input type="text" id="new-comp-icon" placeholder="Icon filename (e.g., en-premierleague.png)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 5px;">
      <button onclick="addNewCompetition()" style="width: 100%; padding: 10px; background: #ff2525; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">+ Add Competition</button>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 20px;">
      <h3 style="color: #fff; font-size: 1em; margin-bottom: 10px;">Existing Competitions</h3>
      <div id="competitions-list" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <button onclick="closeCompetitionManager()" style="width: 100%; padding: 10px; margin-top: 20px; background: #333; color: #ccc; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Close</button>
  `;

  modal.appendChild(dialog);
  document.body.appendChild(modal);

  loadCompetitionsIntoManager();
}

async function loadCompetitionsIntoManager() {
  try {
    const response = await fetch('/api/competitions');
    const result = await response.json();

    if (!result.success) return;

    const list = document.getElementById('competitions-list');
    list.innerHTML = '';

    result.data.forEach(comp => {
      const item = document.createElement('div');
      item.style.cssText = `
        background: #222;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 3px solid #ff2525;
      `;

      const info = document.createElement('div');
      info.style.cssText = 'flex: 1;';
      info.innerHTML = `
        <div style="color: #fff; font-weight: 600;">${comp.name}</div>
        <div style="color: #888; font-size: 0.85em;">${comp.icon || 'No icon'}</div>
      `;

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '‚úï Delete';
      deleteBtn.style.cssText = `
        padding: 5px 10px;
        background: #c0392b;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85em;
      `;
      deleteBtn.onclick = () => deleteCompetition(comp.id);

      item.appendChild(info);
      item.appendChild(deleteBtn);
      list.appendChild(item);
    });
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

async function addNewCompetition() {
  const nameInput = document.getElementById('new-comp-name');
  const iconInput = document.getElementById('new-comp-icon');
  const name = nameInput.value.trim();
  const icon = iconInput.value.trim();

  if (!name) {
    alert('Competition name is required');
    return;
  }

  try {
    const response = await fetch('/api/competitions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, icon: icon || null })
    });

    const result = await response.json();

    if (!result.success) {
      alert('Error: ' + result.error);
      return;
    }

    nameInput.value = '';
    iconInput.value = '';
    loadCompetitionsIntoManager();
    
    // Refresh all dropdown competition selects
    document.querySelectorAll('.dropdown-competition').forEach(select => {
      const currentId = select.value;
      loadCompetitionsForDropdown(select, currentId);
    });
  } catch (error) {
    alert('Error adding competition: ' + error.message);
  }
}

async function deleteCompetition(compId) {
  if (!confirm('Delete this competition?')) return;

  try {
    const response = await fetch(`/api/competitions/${compId}`, {
      method: 'DELETE'
    });

    const result = await response.json();

    if (!result.success) {
      alert('Error: ' + result.error);
      return;
    }

    loadCompetitionsIntoManager();
    
    // Refresh all dropdown competition selects
    document.querySelectorAll('.dropdown-competition').forEach(select => {
      const currentId = select.value;
      if (currentId == compId) select.value = '';
      loadCompetitionsForDropdown(select, currentId);
    });
  } catch (error) {
    alert('Error deleting competition: ' + error.message);
  }
}

function closeCompetitionManager() {
  const modal = document.getElementById('comp-manager-modal');
  if (modal) modal.remove();
}

function addDropdownSection() {
  const container = document.getElementById('dropdowns-container');
  const index = container.children.length;
  renderDropdownEditor({ header: '', subheader: '', subheader2: '', text: '' }, index);
}

function removeDropdown(index) {
  const container = document.getElementById('dropdowns-container');
  container.children[index].remove();
}

function createNewCard() {
  editingCardId = null;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = '';
  document.getElementById('card-subtitle').value = '';
  document.getElementById('card-description').value = '';
  document.getElementById('dropdowns-container').innerHTML = '';

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('carousel-message', 'Creating new card...', 'success');
}

async function saveCard() {
  const title = document.getElementById('card-title').value.trim();
  if (!title) {
    showMessage('carousel-message', 'Card title is required!', 'error');
    return;
  }

  const dropdowns = [];
  document.querySelectorAll('.dropdown-item').forEach(dropdownEl => {
    const header = dropdownEl.querySelector('.dropdown-header').value.trim();
    const subheader = dropdownEl.querySelector('.dropdown-subheader').value.trim();
    const location = dropdownEl.querySelector('.dropdown-location').value.trim();
    const gmt_time = dropdownEl.querySelector('.dropdown-gmt-time').value;
    const competitionSelect = dropdownEl.querySelector('.dropdown-competition');
    const competition_id = competitionSelect.value ? parseInt(competitionSelect.value) : null;
    const subheader2 = dropdownEl.querySelector('.dropdown-subheader2').value.trim();
    const text = dropdownEl.querySelector('.dropdown-text').value.trim();
    const link = dropdownEl.querySelector('.dropdown-link').value.trim();

    if (header || subheader || text) {
      dropdowns.push({ 
        header, 
        subheader, 
        location,
        gmt_time,
        competition_id,
        subheader2, 
        text,
        link
      });
    }
  });

  const cardData = {
    date: document.getElementById('card-date').value,
    title,
    subtitle: document.getElementById('card-subtitle').value.trim(),
    description: document.getElementById('card-description').value.trim(),
    dropdowns
  };

  try {
    const url = editingCardId ? `/api/carousel/insights/${editingCardId}` : '/api/carousel/insights';
    const method = editingCardId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cardData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', editingCardId ? '‚úì Card updated!' : '‚úì Card created!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteCard() {
  if (!editingCardId) {
    showMessage('carousel-message', 'No card selected', 'error');
    return;
  }

  if (!confirm(`Delete card "${document.getElementById('card-title').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/carousel/insights/${editingCardId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', '‚úì Card deleted!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// ========== USER FUNCTIONS ==========
async function loadUsers() {
  try {
    const response = await fetch('/api/admin/users');
    
    if (response.status === 401) {
      showMessage('users-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Failed to load users', 'error');
      return;
    }

    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';

    if (result.data.length === 0) {
      usersList.innerHTML = '<div style="color: #999; text-align: center;">No users found</div>';
      return;
    }

    result.data.forEach(user => {
      const userEl = document.createElement('div');
      userEl.className = 'list-item';
      userEl.onclick = () => selectUser(user);

      const createdDate = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const roleBadge = user.role === 'admin' ? ' üëë Admin' : '';

      userEl.innerHTML = `
        <h4>${user.name}${roleBadge}</h4>
        <p>${user.email}</p>
        <p>ID: ${user.user_uid}</p>
        <p style="font-size: 0.8em;">Joined: ${createdDate}</p>
      `;

      usersList.appendChild(userEl);
    });
  } catch (error) {
    console.error('Error loading users:', error);
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

function selectUser(user) {
  editingUserId = user.id;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = user.name || '';
  document.getElementById('user-email').value = user.email || '';
  document.getElementById('user-role').value = user.role || 'user';
  document.getElementById('user-uid').value = user.user_uid || '';
  document.getElementById('user-created').value = new Date(user.created_at).toLocaleString() || '';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Leave empty to keep current password';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('users-message', `Editing: ${user.name}`, 'success');
}

function createNewUser() {
  editingUserId = null;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = '';
  document.getElementById('user-email').value = '';
  document.getElementById('user-role').value = 'user';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Password (required for new users)';
  document.getElementById('user-uid').value = '';
  document.getElementById('user-created').value = '';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('users-message', 'Creating new user...', 'success');
}

async function saveUser() {
  const name = document.getElementById('user-name').value.trim();
  const email = document.getElementById('user-email').value.trim();
  const password = document.getElementById('user-password').value.trim();
  const role = document.getElementById('user-role').value;

  if (!name || !email) {
    showMessage('users-message', 'Name and email are required!', 'error');
    return;
  }

  if (!editingUserId && !password) {
    showMessage('users-message', 'Password is required for new users!', 'error');
    return;
  }

  const userData = { name, email, role };
  if (password) userData.password = password;

  try {
    const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
    const method = editingUserId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', editingUserId ? '‚úì User updated!' : '‚úì User created!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteUser() {
  if (!editingUserId) {
    showMessage('users-message', 'No user selected', 'error');
    return;
  }

  if (!confirm(`Delete user "${document.getElementById('user-name').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/admin/users/${editingUserId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', '‚úì User deleted!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

// ========== UTILITY FUNCTIONS ==========
function showMessage(elementId, text, type) {
  const messageEl = document.getElementById(elementId);
  messageEl.textContent = text;
  messageEl.className = `message show ${type}`;

  if (type === 'success') {
    setTimeout(() => messageEl.classList.remove('show'), 4000);
  }
}

document.addEventListener('DOMContentLoaded', loadCards);
</script>

</body>
</html>
