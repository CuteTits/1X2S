<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>

    <link rel="stylesheet" href="/assets/css/core/fonts.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200;400&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .material-symbols-outlined {
      font-family: 'Material Symbols Outlined';
      font-weight: 400;
      font-style: normal;
      font-size: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      text-transform: none;
      letter-spacing: normal;
      word-wrap: normal;
      white-space: nowrap;
      direction: ltr;
    }

    ::-webkit-scrollbar {
      width: 5px;
      height: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #0f0f0f;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #f75454;
      border-radius: 10px;
      transition: all 0.5s ease-in-out;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff2e2e;
    }

    body {
      font-family: 'montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0B0B0B;
      min-height: 100vh;
      padding: 15px;
      color: #d4d4d4;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: #141414;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      overflow: hidden;
      border: 1px solid #2a2a2a;
    }

    header {
      background: #1a1a1a;
      color: white;
      padding: 20px 24px;
      text-align: left;
      border-bottom: 1px solid #2a2a2a;
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 4px;
      color: #ffffff;
      font-weight: 600;
    }

    header p {
      color: #808080;
      font-size: 0.8em;
      font-weight: 400;
    }

    .tabs {
      display: flex;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      padding: 0 24px;
      gap: 8px;
    }

    .tab-button {
      padding: 12px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      color: #808080;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .tab-button:hover {
      color: #d4d4d4;
    }

    .tab-button.active {
      color: #ffffff;
      border-bottom-color: #ff4f4f;
    }

    .content {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
      min-height: 600px;
    }

    .sidebar {
      background: #1a1a1a;
      border-right: 1px solid #2a2a2a;
      padding: 16px;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .sidebar h2 {
      color: #ffffff;
      margin-bottom: 12px;
      font-size: 0.9em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .main-section {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      background: #141414;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    label {
      font-weight: 500;
      color: #d4d4d4;
      font-size: 0.8em;
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="time"],
    input[type="password"],
    select,
    textarea {
      padding: 8px 10px;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85em;
      background: #1a1a1a;
      color: #d4d4d4;
      transition: all 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #ff4f4f;
      background: #1f1f1f;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    button .material-symbols-outlined {
      font-size: 1.2em;
    }

    .btn-primary {
      background: #ff4f4f;
      color: white;
      width: 100%;
      margin-bottom: 8px;
    }

    .btn-primary:hover {
      background: #ff3838;
    }

    .btn-danger {
      background: #2a2a2a;
      color: #ff4f4f;
      border: 1px solid #3a3a3a;
      width: 100%;
    }

    .btn-danger:hover {
      background: #333333;
      border-color: #ff4f4f;
    }

    .btn-add {
      background: #1a1a1a;
      color: #ff4f4f;
      border: 1px dashed #3a3a3a;
      width: 100%;
      margin-top: 8px;
    }

    .btn-add:hover {
      background: #222222;
      border-color: #ff4f4f;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .list-item {
      background: #141414;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: #1f1f1f;
      border-color: #3a3a3a;
    }

    .list-item.active {
      background: #1f1f1f;
      border-color: #ff4f4f;
    }

    .list-item h4 {
      margin-bottom: 4px;
      font-size: 0.8em;
      color: #ffffff;
      font-weight: 500;
    }

    .list-item p {
      font-size: 0.7em;
      margin: 2px 0;
      color: #808080;
    }

    .list-item.active p {
      color: #a0a0a0;
    }

    .message {
      padding: 10px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      display: none;
      font-size: 0.8em;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #1a2e1a;
      color: #4ade80;
      border: 1px solid #2a4a2a;
    }

    .message.error {
      background: #2e1a1a;
      color: #ff4f4f;
      border: 1px solid #4a2a2a;
    }

    .no-selection {
      color: #666;
      text-align: center;
      padding: 40px 20px;
      font-size: 0.85em;
    }

    .section-title {
      color: #d4d4d4;
      font-size: 0.85em;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dropdown-item {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .dropdown-item.state-win {
      border-color: rgba(34, 197, 94, 0.35);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.15);
    }

    .dropdown-item.state-loss {
      border-color: rgba(239, 68, 68, 0.35);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.15);
    }

    .dropdown-item.state-open {
      border-color: rgba(59, 130, 246, 0.35);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.15);
    }

    .dropdown-item.state-void {
      border-color: rgba(107, 114, 128, 0.35);
      box-shadow: 0 0 8px rgba(107, 114, 128, 0.12);
    }

    .parent-container {
      transition: border-color 0.3s ease;
    }

    .parent-container.state-win {
      border-color: rgba(34, 197, 94, 0.35) !important;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.16);
    }

    .parent-container.state-loss {
      border-color: rgba(239, 68, 68, 0.35) !important;
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.16);
    }

    .parent-container.state-open {
      border-color: rgba(59, 130, 246, 0.35) !important;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.16);
    }

    .parent-container.state-void {
      border-color: rgba(107, 114, 128, 0.35) !important;
      box-shadow: 0 0 12px rgba(107, 114, 128, 0.16);
    }

    .parent-state-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .parent-state-badge.state-win {
      background: rgba(34, 197, 94, 0.12);
      color: rgba(134, 239, 172, 0.9);
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .parent-state-badge.state-loss {
      background: rgba(239, 68, 68, 0.12);
      color: rgba(248, 113, 113, 0.9);
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .parent-state-badge.state-open {
      background: rgba(59, 130, 246, 0.12);
      color: rgba(147, 197, 253, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.5);
    }

    .parent-state-badge.state-void {
      background: rgba(107, 114, 128, 0.12);
      color: rgba(209, 213, 219, 0.7);
      border: 1px solid rgb(99, 99, 99);
    }

    .dropdown-item-num {
      font-size: 0.75em;
      color: #ff4f4f;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .dropdown-fields {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dropdown-fields input,
    .dropdown-fields textarea {
      font-size: 0.8em;
      padding: 7px 9px;
    }

    .btn-remove {
      background: transparent;
      color: #808080;
      font-size: 0.75em;
      padding: 4px 8px;
      border: 1px solid #2a2a2a;
      width: auto;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .btn-remove:hover {
      background: #2a2a2a;
      color: #ff4f4f;
      border-color: #3a3a3a;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
      min-height: 600px;
    }

    small {
      color: #666;
      font-size: 0.75em;
    }

    .btn-manage-comp {
      background: #2a2a2a;
      color: #d4d4d4;
      border: 1px solid #3a3a3a;
      font-size: 0.75em;
      padding: 7px 10px;
    }

    .btn-manage-comp:hover {
      background: #333333;
      border-color: #4a4a4a;
    }

    .fixed-actions {
      position: fixed;
      right: 20px;
      bottom: 250px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999;
    }

    .fixed-actions button {
      padding: 10px 16px;
      font-size: 0.8em;
      border-radius: 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .fixed-actions .btn-save {
      background: #ff4f4f;
      color: white;
      border: none;
    }

    .fixed-actions .btn-save:hover {
      background: #ff3838;
      box-shadow: 0 4px 12px rgba(255, 79, 79, 0.3);
    }

    .fixed-actions .btn-delete {
      background: #2a2a2a;
      color: #ff4f4f;
      border: 1px solid #3a3a3a;
    }

    .fixed-actions .btn-delete:hover {
      background: #333333;
      border-color: #ff4f4f;
    }

    .fixed-actions .btn-duplicate {
      background: #1a3a3a;
      color: #4ade80;
      border: 1px solid #2a5a5a;
    }

    .fixed-actions .btn-duplicate:hover {
      background: #1f4a4a;
      border-color: #4ade80;
    }

    .btn-duplicate {
      background: #1a3a3a;
      color: #4ade80;
      border: 1px solid #2a5a5a;
      font-size: 0.75em;
      padding: 4px 8px;
      width: auto;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .btn-duplicate:hover {
      background: #1f4a4a;
      border-color: #4ade80;
    }

    .fixed-actions.hidden {
      display: none;
    }

    /* Database Console Styles */
    .db-console {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 250px;
      background: #0B0B0B;
      border-top: 2px solid #ff4f4f;
      border-left: 1px solid #2a2a2a;
      border-right: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
      z-index: 10000;
      font-family: 'Monaco', 'Courier New', monospace;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.5);
    }

    .db-console.minimized {
      height: auto;
    }

    .db-console.minimized .console-body {
      display: none;
    }

    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #141414;
      border-bottom: 1px solid #2a2a2a;
      flex-shrink: 0;
    }

    .console-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #ff4f4f;
      font-weight: 600;
      font-size: 0.9em;
    }

    .console-title .material-symbols-outlined {
      font-size: 1.2em;
    }

    .console-controls {
      display: flex;
      gap: 6px;
    }

    .console-btn {
      background: #1a1a1a;
      color: #d4d4d4;
      border: 1px solid #2a2a2a;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 0.8em;
      transition: all 0.2s;
    }

    .console-btn:hover {
      background: #2a2a2a;
      color: #ff4f4f;
      border-color: #3a3a3a;
    }

    .console-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px 15px;
      font-size: 0.75em;
      line-height: 1.4;
    }

    .console-message {
      margin-bottom: 4px;
      padding: 2px 4px;
      border-left: 2px solid #444;
      padding-left: 8px;
    }

    .console-message.request {
      color: #4ade80;
      border-left-color: #4ade80;
    }

    .console-message.response {
      color: #60a5fa;
      border-left-color: #60a5fa;
    }

    .console-message.error {
      color: #ff4f4f;
      border-left-color: #ff4f4f;
    }

    .console-message.info {
      color: #d4d4d4;
      border-left-color: #666;
    }

    .console-message.timestamp {
      color: #808080;
      font-size: 0.8em;
    }

  </style>
  </style>
</head>
<body>

  <nav>
    <div id="navbar"></div>
    <script src="/assets/js/components/navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/navbar.css">
  </nav>
  <mobilenav>
    <div id="mobilenavbar"></div>
    <script src="/assets/js/components/mobile-navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/mobile-navbar.css">
  </mobilenav>



<div class="container">
  <header>
    <h1><span class="material-symbols-outlined">settings</span> Admin Panel</h1>
    <p>Manage carousel cards and users</p>
  </header>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('carousel')"><span class="material-symbols-outlined">show_chart</span> Carousel</button>
    <button class="tab-button" onclick="switchTab('users')">ðŸ‘¥ Users</button>
  </div>

  <!-- CAROUSEL TAB -->
  <div id="carousel" class="tab-content active">
    <!-- SIDEBAR: Card List -->
    <div class="sidebar">
      <h2>Cards</h2>
      <div id="cards-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewCard()" style="margin-top: 15px;">+ New Card</button>
      <button class="btn-primary" onclick="loadCards()" style="margin-top: 10px;"><span class="material-symbols-outlined">refresh</span> Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit Card -->
    <div class="main-section">
      <div id="carousel-message" class="message"></div>

      <div id="no-card-selection" class="no-selection">
        Select a card to edit or create a new one
      </div>

      <div id="edit-card-form" style="display: none;">
        <div class="form-group">
          <label for="card-date">Date *</label>
          <input type="date" id="card-date">
        </div>

        <div class="form-group">
          <label for="card-title">Card Title *</label>
          <input type="text" id="card-title" placeholder="e.g., 2026 Week 4">
        </div>

        <div class="form-group">
          <label for="card-subtitle">Subtitle</label>
          <input type="text" id="card-subtitle" placeholder="e.g., Champions League">
        </div>

        <div class="form-group">
          <label for="card-description">Short Description</label>
          <textarea id="card-description" placeholder="Brief description..."></textarea>
        </div>

        <div class="section-title">Content Sections</div>
        <div id="parents-container"></div>
        <button class="btn-add" onclick="addParentContainer()">+ Add Section</button>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <p style="color: #808080; font-size: 0.75em; margin-bottom: 12px;">Use buttons at bottom-right or press Ctrl+S to save</p>
      </div>
    </div>
  </div>

  <!-- USERS TAB -->
  <div id="users" class="tab-content">
    <!-- SIDEBAR: User List -->
    <div class="sidebar">
      <h2>Users</h2>
      <div id="users-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewUser()" style="margin-top: 15px;">+ New User</button>
      <button class="btn-primary" onclick="loadUsers()" style="margin-top: 10px;"><span class="material-symbols-outlined">refresh</span> Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit User -->
    <div class="main-section">
      <div id="users-message" class="message"></div>

      <div id="no-user-selection" class="no-selection">
        Select a user to edit or create a new one
      </div>

      <div id="edit-user-form" style="display: none;">
        <div class="form-group">
          <label for="user-name">Name *</label>
          <input type="text" id="user-name" placeholder="Full name">
        </div>

        <div class="form-group">
          <label for="user-email">Email *</label>
          <input type="email" id="user-email" placeholder="email@example.com">
        </div>

        <div class="form-group">
          <label for="user-password">Password *</label>
          <input type="password" id="user-password" placeholder="Password (leave empty to keep current)">
          <small style="color: #666;">Leave empty to keep the current password when editing</small>
        </div>

        <div class="form-group">
          <label for="user-role">Role *</label>
          <select id="user-role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="user-uid">User UID (Read-only)</label>
          <input type="text" id="user-uid" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="form-group">
          <label for="user-created">Created At (Read-only)</label>
          <input type="text" id="user-created" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <button class="btn-primary" onclick="saveUser()"><span class="material-symbols-outlined">save</span> Save User</button>
        <button class="btn-danger" onclick="deleteUser()"><span class="material-symbols-outlined">delete</span> Delete User</button>
      </div>
    </div>
  </div>
</div>

  <!-- Fixed Database Console -->
  <div id="db-console" class="db-console">
    <div class="console-header">
      <div class="console-title">
        <span class="material-symbols-outlined">terminal</span>
        Database Console
      </div>
      <div class="console-controls">
        <button onclick="toggleConsole()" title="Minimize/Maximize" class="console-btn">
          <span class="material-symbols-outlined">unfold_more</span>
        </button>
        <button onclick="clearConsole()" title="Clear Logs" class="console-btn">
          <span class="material-symbols-outlined">delete_sweep</span>
        </button>
        <button onclick="closeConsole()" title="Close" class="console-btn">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
    <div class="console-body" id="console-body">
      <div class="console-message info">Console initialized. Ready to log database actions.</div>
    </div>
  </div>

<script>
let editingCardId = null;
let editingUserId = null;

// ========== SAFE JSON PARSING HELPER ==========
async function safeJsonResponse(response, endpoint = 'API') {
  // Check if response is OK
  if (!response.ok) {
    console.error(`${endpoint} error - Status:`, response.status, response.statusText);
    throw new Error(`${endpoint} failed with status ${response.status}`);
  }

  // Check content type
  const contentType = response.headers.get('content-type');
  if (!contentType || !contentType.includes('application/json')) {
    console.error(`${endpoint} returned non-JSON:`, contentType);
    const text = await response.text();
    console.error('Response text:', text.substring(0, 200));
    throw new Error(`${endpoint} returned invalid content type: ${contentType}`);
  }

  return await response.json();
}

// ========== DATABASE CONSOLE ==========
let consoleMaxLogs = 100;
let consoleLogs = [];

function addConsoleLog(message, type = 'info', data = null) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = {
    message,
    type,
    data,
    timestamp
  };
  
  consoleLogs.push(logEntry);
  
  // Keep only last N logs
  if (consoleLogs.length > consoleMaxLogs) {
    consoleLogs.shift();
  }

  const consoleBody = document.getElementById('console-body');
  if (consoleBody) {
    const logDiv = document.createElement('div');
    logDiv.className = `console-message ${type}`;
    
    let displayMessage = message;
    if (data) {
      try {
        displayMessage += ` â†’ ${JSON.stringify(data).substring(0, 100)}`;
      } catch (e) {
        displayMessage += ` â†’ [Complex Object]`;
      }
    }
    
    logDiv.innerHTML = `<span class="console-message timestamp">[${timestamp}]</span> ${escapeHtml(displayMessage)}`;
    consoleBody.appendChild(logDiv);
    consoleBody.scrollTop = consoleBody.scrollHeight;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function clearConsole() {
  consoleLogs = [];
  const consoleBody = document.getElementById('console-body');
  if (consoleBody) {
    consoleBody.innerHTML = '<div class="console-message info">Console cleared.</div>';
  }
}

function toggleConsole() {
  const console = document.getElementById('db-console');
  console.classList.toggle('minimized');
}

function closeConsole() {
  const console = document.getElementById('db-console');
  console.style.display = 'none';
}

// Intercept fetch calls
const originalFetch = window.fetch;
window.fetch = function(...args) {
  const [url, config] = args;
  const method = (config?.method || 'GET').toUpperCase();
  
  addConsoleLog(`${method} ${url}`, 'request', config?.body ? JSON.parse(config.body) : null);
  
  return originalFetch.apply(this, args)
    .then(response => {
      const status = response.status;
      const statusType = status >= 400 ? 'error' : 'response';
      addConsoleLog(`${method} ${url} - Status ${status}`, statusType);
      return response;
    })
    .catch(error => {
      addConsoleLog(`${method} ${url} - Error: ${error.message}`, 'error');
      throw error;
    });
};

// ========== AUTHENTICATION CHECK ==========
async function checkAdminAuth() {
  try {
    const response = await fetch('/api/session');
    const result = await safeJsonResponse(response, '/api/session');

    if (!result.loggedIn || !result.user) {
      // Not logged in - redirect to login
      window.location.href = '/login/';
      return false;
    }

    // Check if user has admin role
    if (result.user.role !== 'admin') {
      // Not an admin - show error and redirect
      alert('â›” Access denied. Admin access required.');
      window.location.href = '/';
      return false;
    }

    // User is admin, show admin panel
    console.log('âœ… Logged in as admin:', result.user.name);
    loadCompetitions(); // Load competitions dropdown
    loadCards(); // Auto-load carousel on page load
    return true;
  } catch (err) {
    console.error('Auth check error:', err);
    alert('Error: ' + err.message + '\n\nPlease check browser console for details.');
    window.location.href = '/login/';
    return false;
  }
}

// DOMContentLoaded will be handled below after fixed-actions setup

// ========== COMPETITIONS MANAGEMENT ==========
async function loadCompetitions() {
  try {
    const response = await fetch('/api/competitions');
    const result = await safeJsonResponse(response, '/api/competitions');

    if (!result.success) return;

    const select = document.getElementById('card-competition');
    select.innerHTML = '<option value="">-- Select Competition --</option>';

    result.data.forEach(comp => {
      const option = document.createElement('option');
      option.value = comp.id;
      option.textContent = comp.name;
      if (comp.icon) option.dataset.icon = comp.icon;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

function showCompetitionIcon() {
  const select = document.getElementById('card-competition');
  const selectedOption = select.options[select.selectedIndex];
  const icon = selectedOption.dataset.icon;
  const preview = document.getElementById('competition-icon-preview');
  const img = document.getElementById('competition-icon-img');

  if (icon) {
    // Check if it's a URL or a filename
    const iconPath = icon.startsWith('http') ? icon : `/assets/images/league-icons/${icon}`;
    img.src = iconPath;
    img.onerror = () => {
      img.src = '/assets/images/league-icons/default.png';
    };
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

async function addNewCompetition() {
  const name = document.getElementById('card-new-competition').value.trim();
  const icon = document.getElementById('card-new-competition-icon').value.trim();
  
  if (!name) {
    showMessage('carousel-message', 'Competition name is required', 'error');
    return;
  }

  try {
    const response = await fetch('/api/competitions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, icon: icon || null })
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    document.getElementById('card-new-competition').value = '';
    document.getElementById('card-new-competition-icon').value = '';
    showMessage('carousel-message', '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Competition added!', 'success');
    loadCompetitions();
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// ========== TAB SWITCHING ==========
function switchTab(tab) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

  // Show selected tab
  document.getElementById(tab).classList.add('active');
  event.target.classList.add('active');

  // Load data for the tab
  if (tab === 'carousel') {
    loadCards();
  } else if (tab === 'users') {
    loadUsers();
  }
}

// ========== CAROUSEL FUNCTIONS ==========
async function loadCards() {
  try {
    const response = await fetch('/api/carousel/insights');
    
    if (response.status === 401) {
      showMessage('carousel-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await safeJsonResponse(response, '/api/carousel/insights');

    if (!result.success) {
      showMessage('carousel-message', 'Failed to load cards', 'error');
      return;
    }

    const cardsList = document.getElementById('cards-list');
    cardsList.innerHTML = '';

    if (result.data.length === 0) {
      cardsList.innerHTML = '<div style="color: #999; text-align: center;">No cards found</div>';
      return;
    }

    result.data.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.className = 'list-item';
      cardEl.onclick = () => selectCard(card);

      const dateStr = card.date ? new Date(card.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No date';

      cardEl.innerHTML = `
        <h4>${card.title}</h4>
        <p>${dateStr} â€¢ ID: ${card.id}</p>
        <p>${card.dropdowns?.length || 0} dropdowns</p>
      `;

      cardsList.appendChild(cardEl);
    });
  } catch (error) {
    console.error('Error loading cards:', error);
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

function selectCard(card) {
  editingCardId = card.id;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = card.date || new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = card.title || '';
  document.getElementById('card-subtitle').value = card.subtitle || '';
  document.getElementById('card-description').value = card.description || '';

  const parentsContainer = document.getElementById('parents-container');
  parentsContainer.innerHTML = '';

  // Handle new structure: parents with nested dropdowns
  if (card.parents && card.parents.length > 0) {
    card.parents.forEach((parent, idx) => {
      parent._expanded = true; // Expand loaded parents so users can edit them
      renderParentContainer(parent, idx);
    });
  } else if (card.dropdowns && card.dropdowns.length > 0) {
    // Fallback: convert old flat structure to new hierarchical structure
    const newParent = {
      title: 'Predictions',
      text: '',
      dropdowns: card.dropdowns,
      _expanded: true // Expand by default so content is visible
    };
    renderParentContainer(newParent, 0);
  }

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('carousel-message', `Editing: ${card.title}`, 'success');
  updateFixedActionsVisibility();
}

function addParentContainer() {
  const container = document.getElementById('parents-container');
  const index = container.children.length;
  renderParentContainer({ title: '', text: '', dropdowns: [], _expanded: true }, index);
}

function renderParentContainer(parent, parentIndex) {
  const container = document.getElementById('parents-container');
  const parentEl = document.createElement('div');
  parentEl.className = 'parent-container';
  parentEl.dataset.parentIndex = parentIndex;
  parentEl.style.cssText = 'border: 1px solid #2a2a2a; border-radius: 4px; margin-bottom: 12px; background: #1a1a1a; overflow: hidden;';

  const isExpanded = parent._expanded !== false; // Default to expanded for new items, collapsed for loaded
  
  parentEl.innerHTML = `
    <div class="parent-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #1f1f1f; cursor: pointer; user-select: none;" onclick="toggleParentExpand(this)">
      <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
        <span class="parent-toggle-icon" style="display: inline-block; width: 14px; text-align: center; color: #ff4f4f; transition: transform 0.2s; transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'}; font-size: 0.7em;">â–¶</span>
        <h3 style="color: #ffffff; margin: 0; font-size: 0.85em; font-weight: 500;">${parent.title || `Section ${parentIndex + 1}`}</h3>
        <span class="parent-state-badge state-${parent.state || 'open'}">${parent.state === 'win' ? 'âœ“ Won' : parent.state === 'loss' ? 'âœ• Lost' : parent.state === 'void' ? 'â—‹ Void' : 'â—‹ Open'}</span>
        <span class="parent-odds-display" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 0.7em; font-weight: 600; background: rgba(59, 130, 246, 0.12); color: rgba(147, 197, 253, 0.9); border: 1px solid rgba(59, 130, 246, 0.3);">@ <span class="parent-odds-value">1.00</span></span>
      </div>
      <button class="btn-remove" onclick="event.stopPropagation(); removeParentContainer(${parentIndex})">Remove</button>
    </div>

    <div class="parent-content" style="display: ${isExpanded ? 'block' : 'none'}; padding: 14px; max-height: ${isExpanded ? '10000px' : '0'}; transition: max-height 0.3s ease; overflow: hidden;">
      <div class="parent-fields" style="margin-bottom: 12px;">
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.8em; display: block; margin-bottom: 6px;">Section Title</label>
        <input type="text" class="parent-title" placeholder="e.g., Champions League Predictions" value="${parent.title || ''}" style="width: 100%; padding: 8px 10px; background: #141414; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 10px; font-size: 0.85em;">
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.8em; display: block; margin-bottom: 6px;">Section Description</label>
        <textarea class="parent-text" placeholder="Description or intro text for this section..." style="width: 100%; padding: 8px 10px; background: #141414; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; min-height: 60px; margin-bottom: 10px; font-size: 0.85em;">${parent.text || ''}</textarea>
        
        <div style="display: flex; gap: 10px; align-items: flex-end;">
          <div style="flex: 1;">
            <label style="color: #d4d4d4; font-weight: 500; font-size: 0.8em; display: block; margin-bottom: 6px;">Combined Odds</label>
            <input type="text" class="parent-odds-manual" placeholder="e.g., 5.25" value="${parent.total_odds || ''}" style="width: 100%; padding: 8px 10px; background: #141414; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; font-size: 0.85em;" oninput="updateParentOdds(${parentIndex})">
          </div>
          <div style="flex: 0 0 auto;">
            <label style="color: #d4d4d4; font-weight: 500; font-size: 0.8em; display: block; margin-bottom: 6px;">Mode</label>
            <select class="parent-odds-mode" onchange="updateParentOdds(${parentIndex})" style="padding: 8px 10px; background: #141414; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; font-size: 0.85em;">
              <option value="auto" ${parent.odds_mode !== 'manual' ? 'selected' : ''}>Auto</option>
              <option value="manual" ${parent.odds_mode === 'manual' ? 'selected' : ''}>Manual</option>
            </select>
          </div>
        </div>
      </div>

      <div style="background: #141414; padding: 12px 12px 0 12px; border-radius: 4px; border: 1px solid #2a2a2a; margin-bottom: 0;">
        <h4 style="color: #d4d4d4; margin: 0 0 10px 0; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Matches / Predictions</h4>
        <div class="dropdowns-container" data-parent-index="${parentIndex}"></div>
        <button class="btn-add" onclick="addDropdownToParent(${parentIndex})" style="width: 100%; margin-top: 8px; margin-bottom: 12px;">+ Add Match / Prediction</button>
      </div>
    </div>
  `;

  container.appendChild(parentEl);

  // Render existing dropdowns
  if (parent.dropdowns && parent.dropdowns.length > 0) {
    parent.dropdowns.forEach((dropdown, idx) => {
      renderDropdownEditor(dropdown, idx, parentIndex);
    });
    // Update parent state after all dropdowns are rendered
    setTimeout(() => {
      updateParentState(parentIndex);
      updateParentOdds(parentIndex);
    }, 0);
  }
}

function toggleParentExpand(headerElement) {
  const contentEl = headerElement.nextElementSibling;
  const iconEl = headerElement.querySelector('.parent-toggle-icon');
  const isHidden = contentEl.style.display === 'none';
  
  contentEl.style.display = isHidden ? 'block' : 'none';
  iconEl.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
}

function addDropdownToParent(parentIndex) {
  const dropsContainer = document.querySelector(`.dropdowns-container[data-parent-index="${parentIndex}"]`);
  const index = dropsContainer.children.length;
  renderDropdownEditor({ header: '', subheader: '', location: '', gmt_time: '', competition_id: null, link: '', subheader2: '', text: '', total_odds: '', state: 'open', _expanded: true }, index, parentIndex);
  // Update parent state after adding new dropdown
  setTimeout(() => {
    updateParentState(parentIndex);
    updateParentOdds(parentIndex);
  }, 0);
}

function renderDropdownEditor(dropdown, dropdownIndex, parentIndex) {
  const dropsContainer = document.querySelector(`[data-parent-index="${parentIndex}"]`);
  const dropdownEl = document.createElement('div');
  dropdownEl.className = 'dropdown-item';
  if (dropdown.state) {
    dropdownEl.classList.add(`state-${dropdown.state}`);
  }
  dropdownEl.dataset.dropdownIndex = dropdownIndex;
  dropdownEl.dataset.parentIndex = parentIndex;
  dropdownEl.style.cssText = 'background: #141414; border-radius: 4px; margin-bottom: 8px; overflow: hidden;';

  const previewText = `${dropdown.header || 'Match'}${dropdown.subheader ? ' - ' + dropdown.subheader : ''}`.substring(0, 50);
  const isExpanded = dropdown._expanded === true;
  const oddsValue = dropdown.state === 'void' ? '1.0' : (dropdown.total_odds || '');
  
  dropdownEl.innerHTML = `
    <div class="dropdown-toggle-header" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #1a1a1a; cursor: pointer; user-select: none;" onclick="toggleDropdownExpand(this)">
      <div style="display: flex; align-items: center; gap: 6px; flex: 1;">
        <span class="dropdown-toggle-icon" style="display: inline-block; width: 12px; text-align: center; color: #808080; transition: transform 0.2s; transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'}; font-size: 0.7em;">â–¶</span>
        <span style="color: #d4d4d4; font-size: 0.8em; font-weight: 400;">${previewText}${previewText.length >= 50 ? '...' : ''}</span>
      </div>
      <div style="display: flex; gap: 4px;">
        <button class="btn-duplicate" onclick="event.stopPropagation(); duplicateDropdown(${dropdownIndex}, ${parentIndex})" title="Duplicate this match"><span class="material-symbols-outlined">content_copy</span></button>
        <button class="btn-remove" onclick="event.stopPropagation(); removeDropdown(${dropdownIndex}, ${parentIndex})"><span class="material-symbols-outlined">close</span></button>
      </div>
    </div>
    
    <div class="dropdown-content" style="display: ${isExpanded ? 'block' : 'none'}; padding: 12px; max-height: ${isExpanded ? '10000px' : '0'}; transition: max-height 0.3s ease; overflow: hidden;">
      <div class="dropdown-fields">
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin-bottom: 5px; display: block;">Match Details</label>
        <input type="text" class="dropdown-header" placeholder="Match (e.g., Over 2.5 Goals)" value="${dropdown.header || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        <input type="text" class="dropdown-subheader" placeholder="Teams (e.g., Arsenal vs Newcastle)" value="${dropdown.subheader || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Location</label>
        <input type="text" class="dropdown-location" placeholder="e.g., Emirates Stadium" value="${dropdown.location || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">GMT Time (Kickoff)</label>
        <input type="time" class="dropdown-gmt-time" value="${dropdown.gmt_time || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Competition</label>
        <div style="display: flex; gap: 6px; align-items: flex-start; margin-bottom: 6px;">
          <select class="dropdown-competition" onchange="showDropdownCompetitionIcon(this)" style="flex: 1; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; font-size: 0.8em;">
            <option value="">-- Select Competition --</option>
          </select>
          <button class="btn-manage-comp" onclick="openCompetitionManager(event)"><span class="material-symbols-outlined">settings</span></button>
        </div>
        <div class="dropdown-competition-preview" style="margin-bottom: 6px; text-align: center; display: none;">
          <img class="dropdown-competition-icon" src="" alt="Competition Icon" style="max-height: 28px; border-radius: 3px;">
        </div>
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Link</label>
        <input type="text" class="dropdown-link" placeholder="e.g., https://example.com/match" value="${dropdown.link || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Additional Info</label>
        <input type="text" class="dropdown-subheader2" placeholder="Secondary info (optional)" value="${dropdown.subheader2 || ''}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; margin-bottom: 6px; font-size: 0.8em;">
        
        <div style="display: flex; gap: 8px; margin-bottom: 6px;">
          <div style="flex: 1;">
            <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Total Odds</label>
            <input type="text" class="dropdown-total-odds" placeholder="e.g., 2.50" value="${oddsValue}" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; font-size: 0.8em;">
          </div>
          <div style="flex: 1;">
            <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">State</label>
            <select class="dropdown-state" onchange="updateDropdownState(this)" style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; font-size: 0.8em;">
              <option value="open" ${dropdown.state === 'open' ? 'selected' : ''}>Open</option>
              <option value="win" ${dropdown.state === 'win' ? 'selected' : ''}>Win</option>
              <option value="loss" ${dropdown.state === 'loss' ? 'selected' : ''}>Loss</option>
              <option value="void" ${dropdown.state === 'void' ? 'selected' : ''}>Void</option>
            </select>
          </div>
        </div>
        
        <label style="color: #d4d4d4; font-weight: 500; font-size: 0.75em; margin: 8px 0 5px 0; display: block;">Analysis/Reasoning</label>
        <textarea class="dropdown-text" placeholder="Text/Reasoning..." style="width: 100%; padding: 7px 9px; background: #1a1a1a; border: 1px solid #2a2a2a; color: #d4d4d4; border-radius: 4px; min-height: 60px; font-size: 0.8em;">${dropdown.text || ''}</textarea>
      </div>
    </div>
  `;

  dropsContainer.appendChild(dropdownEl);
  
  // Load competitions into this dropdown's select
  loadCompetitionsForDropdown(dropdownEl.querySelector('.dropdown-competition'), dropdown.competition_id);
}

function toggleDropdownExpand(headerElement) {
  const contentEl = headerElement.nextElementSibling;
  const iconEl = headerElement.querySelector('.dropdown-toggle-icon');
  const isHidden = contentEl.style.display === 'none';
  
  contentEl.style.display = isHidden ? 'block' : 'none';
  contentEl.style.maxHeight = isHidden ? '10000px' : '0';
  iconEl.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
}

function removeDropdown(dropdownIndex, parentIndex) {
  const dropsContainer = document.querySelector(`[data-parent-index="${parentIndex}"]`);
  const dropdownEl = dropsContainer.querySelector(`[data-dropdown-index="${dropdownIndex}"]`);
  if (dropdownEl) {
    dropdownEl.remove();
    // Update parent state after removing dropdown
    setTimeout(() => {
      updateParentState(parentIndex);
      updateParentOdds(parentIndex);
    }, 0);
  }
}

function updateDropdownState(selectElement) {
  const dropdownItem = selectElement.closest('.dropdown-item');
  const state = selectElement.value;
  
  // Remove all state classes
  dropdownItem.classList.remove('state-win', 'state-loss', 'state-open', 'state-void');
  
  // Add the current state class
  if (state) {
    dropdownItem.classList.add(`state-${state}`);
  }

  if (state === 'void') {
    const oddsInput = dropdownItem.querySelector('.dropdown-total-odds');
    if (oddsInput) oddsInput.value = '1.0';
  }
  
  // Update parent state and odds
  const parentIndex = dropdownItem.dataset.parentIndex;
  updateParentState(parentIndex);
  updateParentOdds(parentIndex);
}

function updateParentState(parentIndex) {
  const parentContainer = document.querySelector(`.parent-container[data-parent-index="${parentIndex}"]`);
  if (!parentContainer) return;
  
  const dropdowns = parentContainer.querySelectorAll('.dropdown-item');
  const states = Array.from(dropdowns).map(dd => dd.querySelector('.dropdown-state')?.value || 'open');
  const nonVoidStates = states.filter(state => state !== 'void');
  
  let parentState = 'open';
  if (nonVoidStates.length === 0 && states.includes('void')) {
    parentState = 'void';
  }
  
  // Any bet marked as "lost" = automatically mark parent section as "lost"
  if (parentState !== 'void' && nonVoidStates.includes('loss')) {
    parentState = 'loss';
  }
  // Won/open with at least 1 open = parent section is "open"
  else if (parentState !== 'void' && nonVoidStates.includes('open')) {
    parentState = 'open';
  }
  // All bets are won = parent section is "won"
  else if (parentState !== 'void' && nonVoidStates.length > 0 && nonVoidStates.every(s => s === 'win')) {
    parentState = 'win';
  }
  
  // Update parent container class
  parentContainer.classList.remove('state-win', 'state-loss', 'state-open', 'state-void');
  parentContainer.classList.add(`state-${parentState}`);
  
  // Update state badge
  const badge = parentContainer.querySelector('.parent-state-badge');
  if (badge) {
    badge.className = `parent-state-badge state-${parentState}`;
    badge.textContent = parentState === 'win' ? 'âœ“ Won' : parentState === 'loss' ? 'âœ• Lost' : parentState === 'void' ? 'â—‹ Void' : 'â—‹ Open';
  }
  
  return parentState;
}

function calculateCombinedOdds(parentIndex) {
  const parentContainer = document.querySelector(`.parent-container[data-parent-index="${parentIndex}"]`);
  if (!parentContainer) return 1.0;
  
  const dropdowns = parentContainer.querySelectorAll('.dropdown-item');
  let combinedOdds = 1.0;
  
  dropdowns.forEach(dd => {
    const oddsInput = dd.querySelector('.dropdown-total-odds');
    const oddsValue = parseFloat(oddsInput?.value || '1.0');
    if (!isNaN(oddsValue) && oddsValue > 0) {
      combinedOdds *= oddsValue;
    }
  });
  
  return combinedOdds;
}

function updateParentOdds(parentIndex) {
  const parentContainer = document.querySelector(`.parent-container[data-parent-index="${parentIndex}"]`);
  if (!parentContainer) return;
  
  const modeSelect = parentContainer.querySelector('.parent-odds-mode');
  const manualInput = parentContainer.querySelector('.parent-odds-manual');
  const displayValue = parentContainer.querySelector('.parent-odds-value');
  
  const mode = modeSelect?.value || 'auto';
  
  let oddsValue;
  if (mode === 'manual') {
    oddsValue = parseFloat(manualInput?.value || '1.0');
    manualInput.disabled = false;
    manualInput.style.opacity = '1';
  } else {
    oddsValue = calculateCombinedOdds(parentIndex);
    manualInput.value = oddsValue.toFixed(2);
    manualInput.disabled = true;
    manualInput.style.opacity = '0.6';
  }
  
  if (displayValue) {
    displayValue.textContent = oddsValue.toFixed(2);
  }
}

function removeParentContainer(parentIndex) {
  const parentEl = document.querySelector(`[data-parent-index="${parentIndex}"]`).closest('.parent-container');
  if (parentEl) parentEl.remove();
}

async function loadCompetitionsForDropdown(selectElement, selectedId) {
  try {
    const response = await fetch('/api/competitions');
    const result = await response.json();

    if (!result.success) return;

    selectElement.innerHTML = '<option value="">-- Select Competition --</option>';

    result.data.forEach(comp => {
      const option = document.createElement('option');
      option.value = comp.id;
      option.textContent = comp.name;
      if (comp.icon) option.dataset.icon = comp.icon;
      if (comp.id == selectedId) option.selected = true;
      selectElement.appendChild(option);
    });
    
    // Show icon if already selected
    if (selectedId) {
      showDropdownCompetitionIcon(selectElement);
    }
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

function showDropdownCompetitionIcon(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const icon = selectedOption.dataset.icon;
  const preview = selectElement.closest('.dropdown-fields').querySelector('.dropdown-competition-preview');
  const img = preview.querySelector('.dropdown-competition-icon');

  if (icon) {
    const iconPath = icon.startsWith('http') ? icon : `/assets/images/league-icons/${icon}`;
    img.src = iconPath;
    img.onerror = () => {
      img.src = '/assets/images/league-icons/default.png';
    };
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

function openCompetitionManager(event) {
  event.preventDefault();
  const modal = document.createElement('div');
  modal.id = 'comp-manager-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;

  const dialog = document.createElement('div');
  dialog.style.cssText = `
    background: #0B0B0B;
    border: 2px solid #ff2525;
    border-radius: 10px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    color: #ccc;
  `;

  dialog.innerHTML = `
    <h2 style="color: #ff2525; margin-bottom: 20px;">Manage Competitions</h2>
    
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; font-size: 1em; margin-bottom: 10px;">Add New Competition</h3>
      <input type="text" id="new-comp-name" placeholder="Competition name" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 5px;">
      <input type="text" id="new-comp-icon" placeholder="Icon filename (e.g., en-premierleague.png)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 5px;">
      <button onclick="addNewCompetition()" style="width: 100%; padding: 10px; background: #ff2525; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">+ Add Competition</button>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 20px;">
      <h3 style="color: #fff; font-size: 1em; margin-bottom: 10px;">Existing Competitions</h3>
      <div id="competitions-list" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <button onclick="closeCompetitionManager()" style="width: 100%; padding: 10px; margin-top: 20px; background: #333; color: #ccc; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Close</button>
  `;

  modal.appendChild(dialog);
  document.body.appendChild(modal);

  loadCompetitionsIntoManager();
}

async function loadCompetitionsIntoManager() {
  try {
    const response = await fetch('/api/competitions');
    const result = await response.json();

    if (!result.success) return;

    const list = document.getElementById('competitions-list');
    list.innerHTML = '';

    result.data.forEach(comp => {
      const item = document.createElement('div');
      item.style.cssText = `
        background: #222;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 3px solid #ff2525;
      `;

      const info = document.createElement('div');
      info.style.cssText = 'flex: 1;';
      info.innerHTML = `
        <div style="color: #fff; font-weight: 600;">${comp.name}</div>
        <div style="color: #888; font-size: 0.85em;">${comp.icon || 'No icon'}</div>
      `;

      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = '<span class="material-symbols-outlined">close</span> Delete';
      deleteBtn.style.cssText = `
        padding: 5px 10px;
        background: #c0392b;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 4px;
      `;
      deleteBtn.onclick = () => deleteCompetition(comp.id);

      item.appendChild(info);
      item.appendChild(deleteBtn);
      list.appendChild(item);
    });
  } catch (error) {
    console.error('Error loading competitions:', error);
  }
}

async function addNewCompetition() {
  const nameInput = document.getElementById('new-comp-name');
  const iconInput = document.getElementById('new-comp-icon');
  const name = nameInput.value.trim();
  const icon = iconInput.value.trim();

  if (!name) {
    alert('Competition name is required');
    return;
  }

  try {
    const response = await fetch('/api/competitions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, icon: icon || null })
    });

    const result = await response.json();

    if (!result.success) {
      alert('Error: ' + result.error);
      return;
    }

    nameInput.value = '';
    iconInput.value = '';
    loadCompetitionsIntoManager();
    
    // Refresh all dropdown competition selects
    document.querySelectorAll('.dropdown-competition').forEach(select => {
      const currentId = select.value;
      loadCompetitionsForDropdown(select, currentId);
    });
  } catch (error) {
    alert('Error adding competition: ' + error.message);
  }
}

async function deleteCompetition(compId) {
  if (!confirm('Delete this competition?')) return;

  try {
    const response = await fetch(`/api/competitions/${compId}`, {
      method: 'DELETE'
    });

    const result = await response.json();

    if (!result.success) {
      alert('Error: ' + result.error);
      return;
    }

    loadCompetitionsIntoManager();
    
    // Refresh all dropdown competition selects
    document.querySelectorAll('.dropdown-competition').forEach(select => {
      const currentId = select.value;
      if (currentId == compId) select.value = '';
      loadCompetitionsForDropdown(select, currentId);
    });
  } catch (error) {
    alert('Error deleting competition: ' + error.message);
  }
}

function closeCompetitionManager() {
  const modal = document.getElementById('comp-manager-modal');
  if (modal) modal.remove();
}

function addDropdownSection() {
  const container = document.getElementById('dropdowns-container');
  const index = container.children.length;
  renderDropdownEditor({ header: '', subheader: '', subheader2: '', text: '' }, index);
}

function removeDropdown(index) {
  const container = document.getElementById('dropdowns-container');
  container.children[index].remove();
}

function createNewCard() {
  editingCardId = null;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = '';
  document.getElementById('card-subtitle').value = '';
  document.getElementById('card-description').value = '';
  document.getElementById('parents-container').innerHTML = '';

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('carousel-message', 'Creating new card...', 'success');
  updateFixedActionsVisibility();
}

async function saveCard() {
  const title = document.getElementById('card-title').value.trim();
  if (!title) {
    showMessage('carousel-message', 'Card title is required!', 'error');
    return;
  }

  const parents = [];
  document.querySelectorAll('.parent-container').forEach(parentEl => {
    const parentTitle = parentEl.querySelector('.parent-title').value.trim();
    const parentText = parentEl.querySelector('.parent-text').value.trim();
    const dropdowns = [];
    
    parentEl.querySelectorAll('.dropdown-item').forEach(dropdownEl => {
      const header = dropdownEl.querySelector('.dropdown-header').value.trim();
      const subheader = dropdownEl.querySelector('.dropdown-subheader').value.trim();
      const location = dropdownEl.querySelector('.dropdown-location').value.trim();
      const gmt_time = dropdownEl.querySelector('.dropdown-gmt-time').value;
      const competitionSelect = dropdownEl.querySelector('.dropdown-competition');
      const competition_id = competitionSelect.value ? parseInt(competitionSelect.value) : null;
      const subheader2 = dropdownEl.querySelector('.dropdown-subheader2').value.trim();
      const text = dropdownEl.querySelector('.dropdown-text').value.trim();
      const link = dropdownEl.querySelector('.dropdown-link').value.trim();
      let total_odds = dropdownEl.querySelector('.dropdown-total-odds').value.trim();
      const state = dropdownEl.querySelector('.dropdown-state').value;
      if (state === 'void') {
        total_odds = '1.0';
      }

      if (header || subheader || text) {
        dropdowns.push({ 
          header, 
          subheader, 
          location,
          gmt_time,
          competition_id,
          subheader2, 
          text,
          link,
          total_odds,
          state
        });
      }
    });

    // Calculate parent state based on dropdowns
    let parentState = 'open';
    if (dropdowns.length > 0) {
      const states = dropdowns.map(d => d.state || 'open');
      const nonVoidStates = states.filter(state => state !== 'void');
      if (nonVoidStates.length === 0 && states.includes('void')) {
        parentState = 'void';
      } else if (nonVoidStates.includes('loss')) {
        parentState = 'loss';
      } else if (nonVoidStates.includes('open')) {
        parentState = 'open';
      } else if (nonVoidStates.every(s => s === 'win')) {
        parentState = 'win';
      }
    }

    if (parentTitle || parentText || dropdowns.length > 0) {
      const oddsMode = parentContainer.querySelector('.parent-odds-mode')?.value || 'auto';
      const oddsValue = parentContainer.querySelector('.parent-odds-manual')?.value || '';
      
      parents.push({
        title: parentTitle,
        text: parentText,
        state: parentState,
        odds_mode: oddsMode,
        total_odds: oddsValue,
        dropdowns
      });
    }
  });

  const cardData = {
    date: document.getElementById('card-date').value,
    title,
    subtitle: document.getElementById('card-subtitle').value.trim(),
    description: document.getElementById('card-description').value.trim(),
    parents
  };

  try {
    const url = editingCardId ? `/api/carousel/insights/${editingCardId}` : '/api/carousel/insights';
    const method = editingCardId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cardData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', editingCardId ? '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Card updated!' : '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Card created!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteCard() {
  if (!editingCardId) {
    showMessage('carousel-message', 'No card selected', 'error');
    return;
  }

  if (!confirm(`Delete card "${document.getElementById('card-title').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/carousel/insights/${editingCardId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Card deleted!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// ========== USER FUNCTIONS ==========
async function loadUsers() {
  try {
    const response = await fetch('/api/admin/users');
    
    if (response.status === 401) {
      showMessage('users-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Failed to load users', 'error');
      return;
    }

    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';

    if (result.data.length === 0) {
      usersList.innerHTML = '<div style="color: #999; text-align: center;">No users found</div>';
      return;
    }

    result.data.forEach(user => {
      const userEl = document.createElement('div');
      userEl.className = 'list-item';
      userEl.onclick = () => selectUser(user);

      const createdDate = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const roleBadge = user.role === 'admin' ? ' ðŸ‘‘ Admin' : '';

      userEl.innerHTML = `
        <h4>${user.name}${roleBadge}</h4>
        <p>${user.email}</p>
        <p>ID: ${user.user_uid}</p>
        <p style="font-size: 0.8em;">Joined: ${createdDate}</p>
      `;

      usersList.appendChild(userEl);
    });
  } catch (error) {
    console.error('Error loading users:', error);
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

function selectUser(user) {
  editingUserId = user.id;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = user.name || '';
  document.getElementById('user-email').value = user.email || '';
  document.getElementById('user-role').value = user.role || 'user';
  document.getElementById('user-uid').value = user.user_uid || '';
  document.getElementById('user-created').value = new Date(user.created_at).toLocaleString() || '';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Leave empty to keep current password';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('users-message', `Editing: ${user.name}`, 'success');
}

function createNewUser() {
  editingUserId = null;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = '';
  document.getElementById('user-email').value = '';
  document.getElementById('user-role').value = 'user';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Password (required for new users)';
  document.getElementById('user-uid').value = '';
  document.getElementById('user-created').value = '';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('users-message', 'Creating new user...', 'success');
}

async function saveUser() {
  const name = document.getElementById('user-name').value.trim();
  const email = document.getElementById('user-email').value.trim();
  const password = document.getElementById('user-password').value.trim();
  const role = document.getElementById('user-role').value;

  if (!name || !email) {
    showMessage('users-message', 'Name and email are required!', 'error');
    return;
  }

  if (!editingUserId && !password) {
    showMessage('users-message', 'Password is required for new users!', 'error');
    return;
  }

  const userData = { name, email, role };
  if (password) userData.password = password;

  try {
    const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
    const method = editingUserId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', editingUserId ? '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> User updated!' : '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> User created!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteUser() {
  if (!editingUserId) {
    showMessage('users-message', 'No user selected', 'error');
    return;
  }

  if (!confirm(`Delete user "${document.getElementById('user-name').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/admin/users/${editingUserId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> User deleted!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

// ========== UTILITY FUNCTIONS ==========
function showMessage(elementId, text, type) {
  const messageEl = document.getElementById(elementId);
  messageEl.textContent = text;
  messageEl.className = `message show ${type}`;

  if (type === 'success') {
    setTimeout(() => messageEl.classList.remove('show'), 4000);
  }
}

// Show/hide fixed actions based on form visibility
function updateFixedActionsVisibility() {
  const form = document.getElementById('edit-card-form');
  const actions = document.getElementById('fixed-actions');
  if (!actions) return;
  
  if (form.style.display !== 'none') {
    actions.classList.remove('hidden');
    // Show/hide delete and duplicate buttons only when editing existing card
    const deleteBtn = actions.querySelector('.btn-delete');
    const duplicateBtn = actions.querySelector('.btn-duplicate');
    if (deleteBtn) deleteBtn.style.display = editingCardId ? 'flex' : 'none';
    if (duplicateBtn) duplicateBtn.style.display = editingCardId ? 'flex' : 'none';
  } else {
    actions.classList.add('hidden');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // Create fixed action buttons
  const fixedActions = document.createElement('div');
  fixedActions.className = 'fixed-actions hidden';
  fixedActions.id = 'fixed-actions';
  fixedActions.innerHTML = `
    <button class="btn-save" onclick="saveCard()" title="Save (Ctrl+S)"><span class="material-symbols-outlined">save</span> Save</button>
    <button class="btn-duplicate" onclick="duplicateCard()" title="Duplicate card"><span class="material-symbols-outlined">content_copy</span> Duplicate</button>
    <button class="btn-delete" onclick="deleteCard()" title="Delete"><span class="material-symbols-outlined">delete</span> Delete</button>
  `;
  document.body.appendChild(fixedActions);

  // Check authentication and load data
  checkAdminAuth();
});

// Duplicate card function
async function duplicateCard() {
  if (!editingCardId) {
    showMessage('carousel-message', 'No card selected to duplicate', 'error');
    return;
  }

  try {
    const response = await fetch(`/api/carousel/insights/${editingCardId}`);
    const result = await response.json();

    if (!result.success || !result.data) {
      showMessage('carousel-message', 'Error loading card data', 'error');
      return;
    }

    const cardData = result.data;
    // Create new card with copied data
    const newCardData = {
      date: new Date().toISOString().split('T')[0],
      title: `${cardData.title} (Copy)`,
      subtitle: cardData.subtitle,
      description: cardData.description,
      parents: cardData.parents || []
    };

    const saveResponse = await fetch('/api/carousel/insights', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newCardData)
    });

    const saveResult = await saveResponse.json();

    if (!saveResult.success) {
      showMessage('carousel-message', 'Error: ' + saveResult.error, 'error');
      return;
    }

    showMessage('carousel-message', '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Card duplicated!', 'success');
    loadCards();
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// Duplicate dropdown/match function
function duplicateDropdown(dropdownIndex, parentIndex) {
  const dropsContainer = document.querySelector(`.dropdowns-container[data-parent-index="${parentIndex}"]`);
  if (!dropsContainer) {
    showMessage('carousel-message', 'Error: Could not find container', 'error');
    return;
  }
  
  const dropdownEl = dropsContainer.querySelector(`[data-dropdown-index="${dropdownIndex}"]`);
  if (!dropdownEl) {
    showMessage('carousel-message', 'Error: Could not find match to duplicate', 'error');
    return;
  }

  // Get all input values from the original dropdown
  const header = dropdownEl.querySelector('.dropdown-header').value;
  const subheader = dropdownEl.querySelector('.dropdown-subheader').value;
  const location = dropdownEl.querySelector('.dropdown-location').value;
  const gmt_time = dropdownEl.querySelector('.dropdown-gmt-time').value;
  const competition_id = dropdownEl.querySelector('.dropdown-competition').value;
  const subheader2 = dropdownEl.querySelector('.dropdown-subheader2').value;
  const text = dropdownEl.querySelector('.dropdown-text').value;
  const link = dropdownEl.querySelector('.dropdown-link').value;

  // Create new dropdown with copied data
  const newIndex = dropsContainer.children.length;
  renderDropdownEditor(
    {
      header: header + ' (Copy)',
      subheader,
      location,
      gmt_time,
      competition_id: competition_id ? parseInt(competition_id) : null,
      subheader2,
      text,
      link,
      _expanded: true
    },
    newIndex,
    parentIndex
  );

  showMessage('carousel-message', '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Match duplicated!', 'success');
}

// Ctrl+S to save
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    const form = document.getElementById('edit-card-form');
    if (form.style.display !== 'none' && editingCardId) {
      saveCard();
    }
  }
});
</script>

</body>
</html>
