<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>

    <link rel="stylesheet" href="/assets/css/core/fonts.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #ddd;
    }

    .tab-button {
      flex: 1;
      padding: 15px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: #555;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      background: #e9ecef;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 0;
      min-height: 600px;
    }

    .sidebar {
      background: #f8f9fa;
      border-right: 2px solid #ddd;
      padding: 20px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .sidebar h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .main-section {
      padding: 30px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }

    label {
      font-weight: 600;
      color: #555;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    input[type="password"],
    select,
    textarea {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="date"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
      margin-bottom: 10px;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
      width: 100%;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-add {
      background: #27ae60;
      color: white;
      width: 100%;
      margin-top: 10px;
    }

    .btn-add:hover {
      background: #229954;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .list-item {
      background: white;
      border: 2px solid #ddd;
      border-radius: 5px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .list-item:hover {
      border-color: #667eea;
      background: #f0f1ff;
      transform: translateX(5px);
    }

    .list-item.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .list-item h4 {
      margin-bottom: 5px;
      font-size: 0.95em;
    }

    .list-item p {
      font-size: 0.85em;
      opacity: 0.8;
      margin: 2px 0;
    }

    .list-item.active p {
      opacity: 0.9;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .no-selection {
      color: #999;
      text-align: center;
      padding: 40px 20px;
      font-style: italic;
    }

    .section-title {
      color: #667eea;
      font-size: 1.1em;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .dropdown-item {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item-num {
      font-size: 0.85em;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .dropdown-fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dropdown-fields input,
    .dropdown-fields textarea {
      font-size: 0.9em;
      padding: 8px;
    }

    .btn-remove {
      background: #e74c3c;
      color: white;
      font-size: 0.85em;
      padding: 6px 12px;
      width: 100%;
      margin-top: 8px;
    }

    .btn-remove:hover {
      background: #c0392b;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 0;
      min-height: 600px;
    }
  </style>
</head>
<body>

  <nav>
    <div id="navbar"></div>
    <script src="/assets/js/components/navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/navbar.css">
  </nav>
  <mobilenav>
    <div id="mobilenavbar"></div>
    <script src="/assets/js/components/mobile-navbar.js"></script>
    <link rel="stylesheet" href="/assets/css/components/mobile-navbar.css">
  </mobilenav>



<div class="container">
  <header>
    <h1>‚öôÔ∏è Admin Panel</h1>
    <p>Manage carousel cards and users</p>
  </header>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('carousel')">üìä Carousel</button>
    <button class="tab-button" onclick="switchTab('users')">üë• Users</button>
  </div>

  <!-- CAROUSEL TAB -->
  <div id="carousel" class="tab-content active">
    <!-- SIDEBAR: Card List -->
    <div class="sidebar">
      <h2>Cards</h2>
      <div id="cards-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewCard()" style="margin-top: 15px;">+ New Card</button>
      <button class="btn-primary" onclick="loadCards()" style="margin-top: 10px;">üîÑ Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit Card -->
    <div class="main-section">
      <div id="carousel-message" class="message"></div>

      <div id="no-card-selection" class="no-selection">
        Select a card to edit or create a new one
      </div>

      <div id="edit-card-form" style="display: none;">
        <div class="form-group">
          <label for="card-date">Date *</label>
          <input type="date" id="card-date">
        </div>

        <div class="form-group">
          <label for="card-title">Card Title *</label>
          <input type="text" id="card-title" placeholder="e.g., 2026 Week 4">
        </div>

        <div class="form-group">
          <label for="card-subtitle">Subtitle</label>
          <input type="text" id="card-subtitle" placeholder="e.g., Champions League">
        </div>

        <div class="form-group">
          <label for="card-description">Short Description</label>
          <textarea id="card-description" placeholder="Brief description..."></textarea>
        </div>

        <div class="section-title">Dropdowns</div>
        <div id="dropdowns-container"></div>
        <button class="btn-add" onclick="addDropdownSection()">+ Add Dropdown</button>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <button class="btn-primary" onclick="saveCard()">üíæ Save Card</button>
        <button class="btn-danger" onclick="deleteCard()">üóëÔ∏è Delete Card</button>
      </div>
    </div>
  </div>

  <!-- USERS TAB -->
  <div id="users" class="tab-content">
    <!-- SIDEBAR: User List -->
    <div class="sidebar">
      <h2>Users</h2>
      <div id="users-list" class="list">
        <div style="color: #999; text-align: center; padding: 20px;">Loading...</div>
      </div>
      <button class="btn-primary" onclick="createNewUser()" style="margin-top: 15px;">+ New User</button>
      <button class="btn-primary" onclick="loadUsers()" style="margin-top: 10px;">üîÑ Refresh</button>
    </div>

    <!-- MAIN SECTION: Edit User -->
    <div class="main-section">
      <div id="users-message" class="message"></div>

      <div id="no-user-selection" class="no-selection">
        Select a user to edit or create a new one
      </div>

      <div id="edit-user-form" style="display: none;">
        <div class="form-group">
          <label for="user-name">Name *</label>
          <input type="text" id="user-name" placeholder="Full name">
        </div>

        <div class="form-group">
          <label for="user-email">Email *</label>
          <input type="email" id="user-email" placeholder="email@example.com">
        </div>

        <div class="form-group">
          <label for="user-password">Password *</label>
          <input type="password" id="user-password" placeholder="Password (leave empty to keep current)">
          <small style="color: #666;">Leave empty to keep the current password when editing</small>
        </div>

        <div class="form-group">
          <label for="user-role">Role *</label>
          <select id="user-role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="user-uid">User UID (Read-only)</label>
          <input type="text" id="user-uid" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="form-group">
          <label for="user-created">Created At (Read-only)</label>
          <input type="text" id="user-created" placeholder="Auto-generated" readonly style="background: #f0f0f0; cursor: not-allowed;">
        </div>

        <div class="section-title" style="margin-top: 30px;">Actions</div>
        <button class="btn-primary" onclick="saveUser()">üíæ Save User</button>
        <button class="btn-danger" onclick="deleteUser()">üóëÔ∏è Delete User</button>
      </div>
    </div>
  </div>
</div>

<script>
let editingCardId = null;
let editingUserId = null;

// ========== AUTHENTICATION CHECK ==========
async function checkAdminAuth() {
  try {
    const response = await fetch('/api/session');
    const result = await response.json();

    if (!result.loggedIn || !result.user) {
      // Not logged in - redirect to login
      window.location.href = '/login/';
      return false;
    }

    // Check if user has admin role
    if (result.user.role !== 'admin') {
      // Not an admin - show error and redirect
      alert('‚õî Access denied. Admin access required.');
      window.location.href = '/';
      return false;
    }

    // User is admin, show admin panel
    console.log('‚úÖ Logged in as admin:', result.user.name);
    loadCards(); // Auto-load carousel on page load
    return true;
  } catch (err) {
    console.error('Auth check error:', err);
    window.location.href = '/login/';
    return false;
  }
}

// Run auth check on page load
document.addEventListener('DOMContentLoaded', checkAdminAuth);

// ========== TAB SWITCHING ==========
function switchTab(tab) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

  // Show selected tab
  document.getElementById(tab).classList.add('active');
  event.target.classList.add('active');

  // Load data for the tab
  if (tab === 'carousel') {
    loadCards();
  } else if (tab === 'users') {
    loadUsers();
  }
}

// ========== CAROUSEL FUNCTIONS ==========
async function loadCards() {
  try {
    const response = await fetch('/api/carousel/insights');
    
    if (response.status === 401) {
      showMessage('carousel-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Failed to load cards', 'error');
      return;
    }

    const cardsList = document.getElementById('cards-list');
    cardsList.innerHTML = '';

    if (result.data.length === 0) {
      cardsList.innerHTML = '<div style="color: #999; text-align: center;">No cards found</div>';
      return;
    }

    result.data.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.className = 'list-item';
      cardEl.onclick = () => selectCard(card);

      const dateStr = card.date ? new Date(card.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No date';

      cardEl.innerHTML = `
        <h4>${card.title}</h4>
        <p>${dateStr} ‚Ä¢ ID: ${card.id}</p>
        <p>${card.dropdowns?.length || 0} dropdowns</p>
      `;

      cardsList.appendChild(cardEl);
    });
  } catch (error) {
    console.error('Error loading cards:', error);
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

function selectCard(card) {
  editingCardId = card.id;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = card.date || new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = card.title || '';
  document.getElementById('card-subtitle').value = card.subtitle || '';
  document.getElementById('card-description').value = card.description || '';

  const dropdownsContainer = document.getElementById('dropdowns-container');
  dropdownsContainer.innerHTML = '';

  if (card.dropdowns && card.dropdowns.length > 0) {
    card.dropdowns.forEach((dropdown, idx) => {
      renderDropdownEditor(dropdown, idx);
    });
  }

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('carousel-message', `Editing: ${card.title}`, 'success');
}

function renderDropdownEditor(dropdown, index) {
  const container = document.getElementById('dropdowns-container');
  const dropdownEl = document.createElement('div');
  dropdownEl.className = 'dropdown-item';
  dropdownEl.dataset.dropdownIndex = index;

  dropdownEl.innerHTML = `
    <div class="dropdown-item-num">Dropdown ${index + 1}</div>
    <div class="dropdown-fields">
      <input type="text" class="dropdown-header" placeholder="Header (e.g., Over 2.5 Goals)" value="${dropdown.header || ''}">
      <input type="text" class="dropdown-subheader" placeholder="Subheader (e.g., Arsenal - Newcastle)" value="${dropdown.subheader || ''}">
      <input type="text" class="dropdown-subheader2" placeholder="Secondary info (optional)" value="${dropdown.subheader2 || ''}">
      <textarea class="dropdown-text" placeholder="Text/Reasoning...">${dropdown.text || ''}</textarea>
      <button class="btn-remove" onclick="removeDropdown(${index})">Remove Dropdown</button>
    </div>
  `;

  container.appendChild(dropdownEl);
}

function addDropdownSection() {
  const container = document.getElementById('dropdowns-container');
  const index = container.children.length;
  renderDropdownEditor({ header: '', subheader: '', subheader2: '', text: '' }, index);
}

function removeDropdown(index) {
  const container = document.getElementById('dropdowns-container');
  container.children[index].remove();
}

function createNewCard() {
  editingCardId = null;
  document.getElementById('no-card-selection').style.display = 'none';
  document.getElementById('edit-card-form').style.display = 'block';

  document.getElementById('card-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('card-title').value = '';
  document.getElementById('card-subtitle').value = '';
  document.getElementById('card-description').value = '';
  document.getElementById('dropdowns-container').innerHTML = '';

  document.querySelectorAll('#cards-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('carousel-message', 'Creating new card...', 'success');
}

async function saveCard() {
  const title = document.getElementById('card-title').value.trim();
  if (!title) {
    showMessage('carousel-message', 'Card title is required!', 'error');
    return;
  }

  const dropdowns = [];
  document.querySelectorAll('.dropdown-item').forEach(dropdownEl => {
    const header = dropdownEl.querySelector('.dropdown-header').value.trim();
    const subheader = dropdownEl.querySelector('.dropdown-subheader').value.trim();
    const subheader2 = dropdownEl.querySelector('.dropdown-subheader2').value.trim();
    const text = dropdownEl.querySelector('.dropdown-text').value.trim();

    if (header || subheader || text) {
      dropdowns.push({ header, subheader, subheader2, text });
    }
  });

  const cardData = {
    date: document.getElementById('card-date').value,
    title,
    subtitle: document.getElementById('card-subtitle').value.trim(),
    description: document.getElementById('card-description').value.trim(),
    dropdowns
  };

  try {
    const url = editingCardId ? `/api/carousel/insights/${editingCardId}` : '/api/carousel/insights';
    const method = editingCardId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cardData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', editingCardId ? '‚úì Card updated!' : '‚úì Card created!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteCard() {
  if (!editingCardId) {
    showMessage('carousel-message', 'No card selected', 'error');
    return;
  }

  if (!confirm(`Delete card "${document.getElementById('card-title').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/carousel/insights/${editingCardId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('carousel-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('carousel-message', '‚úì Card deleted!', 'success');
    loadCards();
    setTimeout(() => {
      document.getElementById('edit-card-form').style.display = 'none';
      document.getElementById('no-card-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('carousel-message', 'Error: ' + error.message, 'error');
  }
}

// ========== USER FUNCTIONS ==========
async function loadUsers() {
  try {
    const response = await fetch('/api/admin/users');
    
    if (response.status === 401) {
      showMessage('users-message', 'Please log in to access admin panel', 'error');
      setTimeout(() => window.location.href = '/login/', 2000);
      return;
    }
    
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Failed to load users', 'error');
      return;
    }

    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';

    if (result.data.length === 0) {
      usersList.innerHTML = '<div style="color: #999; text-align: center;">No users found</div>';
      return;
    }

    result.data.forEach(user => {
      const userEl = document.createElement('div');
      userEl.className = 'list-item';
      userEl.onclick = () => selectUser(user);

      const createdDate = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const roleBadge = user.role === 'admin' ? ' üëë Admin' : '';

      userEl.innerHTML = `
        <h4>${user.name}${roleBadge}</h4>
        <p>${user.email}</p>
        <p>ID: ${user.user_uid}</p>
        <p style="font-size: 0.8em;">Joined: ${createdDate}</p>
      `;

      usersList.appendChild(userEl);
    });
  } catch (error) {
    console.error('Error loading users:', error);
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

function selectUser(user) {
  editingUserId = user.id;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = user.name || '';
  document.getElementById('user-email').value = user.email || '';
  document.getElementById('user-role').value = user.role || 'user';
  document.getElementById('user-uid').value = user.user_uid || '';
  document.getElementById('user-created').value = new Date(user.created_at).toLocaleString() || '';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Leave empty to keep current password';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.list-item')?.classList.add('active');

  showMessage('users-message', `Editing: ${user.name}`, 'success');
}

function createNewUser() {
  editingUserId = null;
  document.getElementById('no-user-selection').style.display = 'none';
  document.getElementById('edit-user-form').style.display = 'block';

  document.getElementById('user-name').value = '';
  document.getElementById('user-email').value = '';
  document.getElementById('user-role').value = 'user';
  document.getElementById('user-password').value = '';
  document.getElementById('user-password').placeholder = 'Password (required for new users)';
  document.getElementById('user-uid').value = '';
  document.getElementById('user-created').value = '';

  document.querySelectorAll('#users-list .list-item').forEach(el => el.classList.remove('active'));
  showMessage('users-message', 'Creating new user...', 'success');
}

async function saveUser() {
  const name = document.getElementById('user-name').value.trim();
  const email = document.getElementById('user-email').value.trim();
  const password = document.getElementById('user-password').value.trim();
  const role = document.getElementById('user-role').value;

  if (!name || !email) {
    showMessage('users-message', 'Name and email are required!', 'error');
    return;
  }

  if (!editingUserId && !password) {
    showMessage('users-message', 'Password is required for new users!', 'error');
    return;
  }

  const userData = { name, email, role };
  if (password) userData.password = password;

  try {
    const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
    const method = editingUserId ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userData)
    });

    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', editingUserId ? '‚úì User updated!' : '‚úì User created!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

async function deleteUser() {
  if (!editingUserId) {
    showMessage('users-message', 'No user selected', 'error');
    return;
  }

  if (!confirm(`Delete user "${document.getElementById('user-name').value}"? This cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/admin/users/${editingUserId}`, { method: 'DELETE' });
    const result = await response.json();

    if (!result.success) {
      showMessage('users-message', 'Error: ' + result.error, 'error');
      return;
    }

    showMessage('users-message', '‚úì User deleted!', 'success');
    loadUsers();
    setTimeout(() => {
      document.getElementById('edit-user-form').style.display = 'none';
      document.getElementById('no-user-selection').style.display = 'block';
    }, 1500);
  } catch (error) {
    showMessage('users-message', 'Error: ' + error.message, 'error');
  }
}

// ========== UTILITY FUNCTIONS ==========
function showMessage(elementId, text, type) {
  const messageEl = document.getElementById(elementId);
  messageEl.textContent = text;
  messageEl.className = `message show ${type}`;

  if (type === 'success') {
    setTimeout(() => messageEl.classList.remove('show'), 4000);
  }
}

document.addEventListener('DOMContentLoaded', loadCards);
</script>

</body>
</html>
